review pr 57767
I'll review PR #57767 for you. Let me fetch the pull request details.
Bash
⎿
Fetch PR #57767 details
IN
gh pr view 57767 --json title,body,author,state,url,headRefName,baseRefName,commits,files
OUT
{"author":{"id":"U_kgDOBsmbVw","is_bot":false,"login":"0AyanamiRei","name":"Refrain"},"baseRefName":"master","body":"### What problem does this PR solve?\r\n\r\nIssue Number: close #xxx\r\n\r\nRelated PR: #xxx\r\n\r\nProblem Summary:\r\n\r\nif DataQualityError happened, this instance will cancel itself downstream BE's load channel ， the LoadChannelMgr will remove this load_id record. \r\n\r\nBut if there are a tablet_writer_add_block rpc in flight, it will cause the unknow load_id error, cuz it can not find this load_id record in the _get_load_channel\r\n\r\n\r\n### Release note\r\n\r\nNone\r\n\r\n### Check List (For Author)\r\n\r\n- Test <!-- At least one of them must be included. -->\r\n    - [ ] Regression test\r\n    - [ ] Unit Test\r\n    - [ ] Manual test (add detailed scripts or steps below)\r\n    - [ ] No need to test or manual test. Explain why:\r\n        - [ ] This is a refactor/code format and no logic has been changed.\r\n        - [ ] Previous test can cover this change.\r\n        - [ ] No code files have been changed.\r\n        - [ ] Other reason <!-- Add your reason?  -->\r\n\r\n- Behavior changed:\r\n    - [ ] No.\r\n    - [ ] Yes. <!-- Explain the behavior change -->\r\n\r\n- Does this need documentation?\r\n    - [ ] No.\r\n    - [ ] Yes. <!-- Add document PR link here. eg: https://github.com/apache/doris-website/pull/1214 -->\r\n\r\n### Check List (For Reviewer who merge this PR)\r\n\r\n- [ ] Confirm the release note\r\n- [ ] Confirm test cases\r\n- [ ] Confirm document\r\n- [ ] Add branch pick label <!-- Add branch pick label that this PR should merge into -->\r\n\r\n","commits":[{"authoredDate":"2025-11-06T11:15:28Z","authors":[{"email":"3244156674@qq.com","id":"U_kgDOBsmbVw","login":"0AyanamiRei","name":"0AyanamiRei"}],"committedDate":"2025-11-06T11:15:28Z","messageBody":"","messageHeadline":"fix","oid":"057b98843ceab9d34b0e8e313bed9d96b7fec468"},{"authoredDate":"2025-11-06T11:39:01Z","authors":[{"email":"113875799+0AyanamiRei@users.noreply.github.com","id":"U_kgDOBsmbVw","login":"0AyanamiRei","name":"Refrain"}],"committedDate":"2025-11-06T11:39:01Z","messageBody":"","messageHeadline":"Merge branch 'master' into FixUnknowId","oid":"92d342351225a6e8ef2cb5bd3449ab6bf5dcf7cf"},{"authoredDate":"2025-11-06T11:43:24Z","authors":[{"email":"3244156674@qq.com","id":"U_kgDOBsmbVw","login":"0AyanamiRei","name":"0AyanamiRei"}],"committedDate":"2025-11-06T11:43:24Z","messageBody":"","messageHeadline":"f","oid":"6e3e6dbfaf22f094b932e11bdb6064121cab9bba"}],"files":[{"path":"be/src/runtime/load_channel_mgr.cpp","additions":14,"deletions":3},{"path":"be/src/runtime/load_channel_mgr.h","additions":9,"deletions":0}],"headRefName":"FixUnknowId","state":"OPEN","title":"[fix](load) Add channel records to fix the unknown load_id error","url":"https://github.com/apache/doris/pull/57767"}
Bash
⎿
Get diff for PR #57767
IN
gh pr diff 57767
OUT
diff --git a/be/src/runtime/load_channel_mgr.cpp b/be/src/runtime/load_channel_mgr.cpp
index 0bb352d2feb803..1f7f608c34a98b 100644
--- a/be/src/runtime/load_channel_mgr.cpp
+++ b/be/src/runtime/load_channel_mgr.cpp
@@ -75,6 +75,7 @@ void LoadChannelMgr::stop() {
 
 Status LoadChannelMgr::init(int64_t process_mem_limit) {
     _last_success_channels = std::make_unique<LastSuccessChannelCache>(1024);
+    _last_cancel_channels = std::make_unique<LastCancelChannelCache>(1024);
     RETURN_IF_ERROR(_start_bg_worker());
     return Status::OK();
 }
@@ -117,15 +118,23 @@ Status LoadChannelMgr::_get_load_channel(std::shared_ptr<LoadChannel>& channel,
     std::lock_guard<std::mutex> l(_lock);
     auto it = _load_channels.find(load_id);
     if (it == _load_channels.end()) {
-        auto* handle = _last_success_channels->lookup(load_id.to_string());
+        auto* handle_success = _last_success_channels->lookup(load_id.to_string());
         // success only when eos be true
-        if (handle != nullptr) {
-            _last_success_channels->release(handle);
+        if (handle_success != nullptr) {
+            _last_success_channels->release(handle_success);
             if (request.has_eos() && request.eos()) {
                 is_eof = true;
                 return Status::OK();
             }
         }
+
+        auto* handle_failed = _last_cancel_channels->lookup(load_id.to_string());
+        // for case
+        if (handle_failed != nullptr) {
+            _last_cancel_channels->release(handle_failed);
+            return Status::OK();
+        }
+
         return Status::InternalError<false>(
                 "Fail to add batch in load channel: unknown load_id={}. "
                 "This may be due to a BE restart. Please retry the load.",
@@ -197,6 +206,8 @@ Status LoadChannelMgr::cancel(const PTabletWriterCancelRequest& params) {
             cancelled_channel = _load_channels[load_id];
             _load_channels.erase(load_id);
         }
+        auto* handle = _last_cancel_channels->insert(load_id.to_string(), nullptr, 1, 1);
+        _last_cancel_channels->release(handle);
     }
 
     if (cancelled_channel != nullptr) {
diff --git a/be/src/runtime/load_channel_mgr.h b/be/src/runtime/load_channel_mgr.h
index 74ced68a1dd4a2..c8edea97e20469 100644
--- a/be/src/runtime/load_channel_mgr.h
+++ b/be/src/runtime/load_channel_mgr.h
@@ -89,12 +89,21 @@ class LoadChannelMgr {
                                  DEFAULT_LRU_CACHE_ELEMENT_COUNT_CAPACITY, false) {}
     };
 
+    class LastCancelChannelCache : public LRUCachePolicy {
+    public:
+        LastCancelChannelCache(size_t capacity)
+                : LRUCachePolicy(CachePolicy::CacheType::LAST_SUCCESS_CHANNEL_CACHE, capacity,
+                                 LRUCacheType::SIZE, -1, DEFAULT_LRU_CACHE_NUM_SHARDS,
+                                 DEFAULT_LRU_CACHE_ELEMENT_COUNT_CAPACITY, false) {}
+    };
+
 protected:
     // lock protect the load channel map
     std::mutex _lock;
     // load id -> load channel
     std::unordered_map<UniqueId, std::shared_ptr<LoadChannel>> _load_channels;
     std::unique_ptr<LastSuccessChannelCache> _last_success_channels;
+    std::unique_ptr<LastCancelChannelCache> _last_cancel_channels;
 
     MemTableMemoryLimiter* _memtable_memory_limiter = nullptr;
Now let me read the relevant files to understand the context better:
Read load_channel_mgr.cpp (lines 2-251), load_channel_mgr.h
PR Review: #57767 - fix Add channel records to fix the unknown load_id error
Summary
This PR addresses a race condition in the load channel management system where cancelled load operations can cause "unknown load_id" errors for in-flight RPCs.
Problem Analysis
The issue occurs when:
A DataQualityError causes a load instance to cancel itself and remove its load_id from LoadChannelMgr
A tablet_writer_add_block RPC is already in-flight during cancellation
The in-flight RPC arrives and cannot find the load_id, resulting in an "unknown load_id" error
This is a legitimate race condition that needs to be addressed.
Solution Review
Architecture: The PR introduces a new LastCancelChannelCache similar to the existing LastSuccessChannelCache to track recently cancelled load channels. Key Changes:
load_channel_mgr.h:92-99 - New LastCancelChannelCache class
✅ Mirrors the design of LastSuccessChannelCache
⚠️ Uses the same cache type enum LAST_SUCCESS_CHANNEL_CACHE - this should likely be a different cache type
load_channel_mgr.cpp:78 - Initialize the cancel cache
✅ Properly initialized with same capacity (1024) as success cache
load_channel_mgr.cpp:131-139 - Check cancel cache in _get_load_channel
✅ Returns Status::OK() for cancelled channels to avoid error
⚠️ Missing the comment "// for case" - incomplete explanation
load_channel_mgr.cpp:209-210 - Insert into cancel cache on cancellation
✅ Adds cancelled load_id to cache when channel is removed
Issues Found
Critical Issues:
Wrong Cache Type Enum: The LastCancelChannelCache uses LAST_SUCCESS_CHANNEL_CACHE cache type. This should be a distinct cache type (e.g., LAST_CANCEL_CHANNEL_CACHE) to avoid potential confusion and metrics issues.
Incomplete Comment: Line 131 has // for case - this comment is incomplete and doesn't explain what case it handles.
No Test Coverage: The PR checklist shows no test coverage. This race condition fix should include at least a unit test or manual test validation.
Memory Management: Unlike the success cache check that only returns OK for eos() requests, the cancel cache returns OK for all requests. This might mask legitimate errors for non-eos requests that arrive after cancellation.
Design Concerns:
Silent Failure: When a cancelled channel is found, the code returns Status::OK() without setting is_eof or providing any indication to the caller that the operation was skipped due to cancellation. This could lead to confusing behavior.
Cache Size: Both caches use 1024 entries. Consider if this is sufficient for high-concurrency scenarios with many concurrent loads.
No Cache Cleanup: There's no TTL or cleanup mechanism for the cancel cache entries. Old cancelled load_ids will remain in cache potentially indefinitely.
Recommendations
Must Fix:
Define and use a proper cache type for LastCancelChannelCache instead of reusing LAST_SUCCESS_CHANNEL_CACHE
Complete the comment explaining what case is being handled
Consider returning a more specific status (e.g., Status::Cancelled) instead of Status::OK() for cancelled channels
Add unit tests to validate the race condition fix
Should Consider:
Align the behavior with the success cache - perhaps only return OK for specific request types
Document the expected behavior when an RPC arrives after cancellation
Add metrics to track how often this race condition occurs
Code Quality
Commit messages are too brief ("fix", "f") - should be descriptive
Missing tests as noted in checklist
The PR description could better explain the expected behavior after the fix
Would you like me to suggest specific code improvements for any of these issues?
